<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è½ä»»åŠ¡</title>
    <style>
        /* å…¨å±€æç®€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.4;
            width: 100%;
            min-height: 100vh;
            padding: 8px;
            font-size: 0.85em; /* æ•´ä½“ç¼©å° */
        }
        
        /* ä¸»å®¹å™¨ */
        .app-container {
            display: flex;
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            min-height: 95vh;
        }
        
        /* å¯æŠ˜å ä¾§è¾¹æ  */
        #calendarSidebar {
            width: 180px;
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }
        
        /* æŠ˜å çŠ¶æ€ */
        #calendarSidebar.collapsed {
            width: 0;
            overflow: hidden;
            border-right: none;
        }
        
        /* æŠ˜å æŒ‰é’® */
        .toggle-sidebar {
            position: absolute;
            right: -15px;
            top: 15px;
            width: 30px;
            height: 30px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        
        .toggle-sidebar:hover {
            background: #475569;
            transform: scale(1.05);
        }
        
        /* æ—¥å†å†…å®¹ */
        .calendar-content {
            padding: 15px 12px;
            height: 100%;
        }
        
        #calendarSidebar.collapsed .calendar-content {
            display: none;
        }
        
        .calendar-header {
            font-size: 1em;
            font-weight: 600;
            color: #475569;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .date-item {
            padding: 6px 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            border-left: 3px solid #3b82f6;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .date-item:hover {
            background: #eff6ff;
        }
        
        .date-item.active {
            background: #3b82f6;
            color: white;
            font-weight: 500;
        }
        
        /* ä¸»å†…å®¹åŒº */
        #mainArea {
            flex-grow: 1;
            padding: 15px;
            font-size: 0.85em; /* ä¸»åŒºåŸŸå­—ä½“æŒ‰0.5emæ¯”ä¾‹ç¼©å° */
        }
        
        /* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .action-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            background: #2563eb;
        }
        
        .action-btn.secondary {
            background: #64748b;
        }
        
        .action-btn.secondary:hover {
            background: #475569;
        }
        
        /* ä»»åŠ¡åŒºåŸŸ */
        .task-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        /* ä»»åŠ¡é¡¹ */
        .task-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f8fafc;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #10b981;
            flex-shrink: 0;
        }
        
        .task-text {
            flex-grow: 1;
            border: none;
            background: transparent;
            font-size: 0.9em;
            padding: 3px 5px;
            color: #334155;
        }
        
        .task-text:focus {
            outline: none;
            background: #f8fafc;
            border-radius: 3px;
        }
        
        /* å·²å®Œæˆä»»åŠ¡æ ·å¼ - ä»…å˜æ·¡ï¼Œä¸åˆ’æ‰ */
        .task-checkbox:checked + .task-text {
            color: #94a3b8;
        }
        
        /* åˆ é™¤æŒ‰é’® */
        .delete-btn {
            opacity: 0;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 0.75em;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        
        .task-item:hover .delete-btn {
            opacity: 1;
        }
        
        /* å›ºå®šä»»åŠ¡æŒ‡ç¤ºå™¨ */
        .fixed-indicator {
            color: #8b5cf6;
            font-size: 0.75em;
            margin-left: 4px;
        }
        
        /* ä»Šæ—¥é«˜äº® */
        .today-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            font-size: 0.7em;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        /* çª—å£æ§åˆ¶æŒ‰é’® */
        .window-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        
        .window-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
        }
        
        .window-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¯æŠ˜å æ—¥å†ä¾§è¾¹æ  -->
        <div id="calendarSidebar">
            <button class="toggle-sidebar" id="toggleSidebarBtn">â—€</button>
            <div class="calendar-content">
                <div class="calendar-header">ğŸ“… ä»»åŠ¡æ—¥å†</div>
                <div id="calendarList"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div id="mainArea">
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div id="controls">
                <button class="action-btn" id="addDynamicTaskBtn">+ ä»Šæ—¥ä»»åŠ¡</button>
                <button class="action-btn secondary" id="copyYesterdayBtn">ğŸ“‹ å¤åˆ¶æ˜¨å¤©</button>
                <button class="action-btn secondary" id="manageFixedTasksBtn">âš™ï¸ å›ºå®šä»»åŠ¡</button>
            </div>
            
            <!-- å›ºå®šä»»åŠ¡åŒºåŸŸ -->
            <div class="task-section">
                <h3 class="section-title">ğŸ”„ æ¯æ—¥å›ºå®šä»»åŠ¡</h3>
                <div id="fixedTasksContainer"></div>
            </div>
            
            <!-- ä»Šæ—¥åŠ¨æ€ä»»åŠ¡åŒºåŸŸ -->
            <div class="task-section">
                <h3 class="section-title" id="todayDateTitle">ğŸ“ ä»Šæ—¥åŠ¨æ€ä»»åŠ¡</h3>
                <div id="dynamicTasksContainer"></div>
            </div>
        </div>
    </div>
    
    <!-- çª—å£æ§åˆ¶æŒ‰é’® -->
    <div class="window-controls">
        <button class="window-btn" id="toggleCompactBtn" title="åˆ‡æ¢ç´§å‡‘æ¨¡å¼">ğŸ“±</button>
        <button class="window-btn" id="exportDataBtn" title="å¯¼å‡ºæ•°æ®">ğŸ“¥</button>
    </div>

    <script>
        // ================ å·¥å…·å‡½æ•° ================
        function getDateStr(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }
        
        // ================ çŠ¶æ€ç®¡ç† ================
        const TODAY = new Date();
        const TODAY_STR = getDateStr(TODAY);
        let currentViewingDate = TODAY_STR;
        let isSidebarCollapsed = false;
        
        // ================ æ•°æ®æ¨¡å‹ ================
        let fixedTasks = JSON.parse(localStorage.getItem('fixedTasks')) || [
            { id: 1, text: "æ™¨é—´é˜…è¯»", completed: false },
            { id: 2, text: "ä»Šæ—¥è®¡åˆ’", completed: false },
            { id: 3, text: "è¿åŠ¨é”»ç‚¼", completed: false },
            { id: 4, text: "å·¥ä½œæ€»ç»“", completed: false }
        ];
        
        let allDailyTasks = JSON.parse(localStorage.getItem('allDailyTasks')) || {};
        
        // ================ åˆå§‹åŒ–æ•°æ® ================
        function ensureDateData(dateStr) {
            if (!allDailyTasks[dateStr]) {
                allDailyTasks[dateStr] = {
                    dynamicTasks: [],
                    fixedTaskStatus: {}
                };
                // åˆå§‹åŒ–å›ºå®šä»»åŠ¡çŠ¶æ€
                fixedTasks.forEach(ft => {
                    allDailyTasks[dateStr].fixedTaskStatus[ft.id] = false;
                });
                saveAllDailyTasks();
            }
        }
        ensureDateData(TODAY_STR);
        
        // ================ æ•°æ®æŒä¹…åŒ– ================
        function saveFixedTasks() {
            localStorage.setItem('fixedTasks', JSON.stringify(fixedTasks));
        }
        
        function saveAllDailyTasks() {
            localStorage.setItem('allDailyTasks', JSON.stringify(allDailyTasks));
        }
        
        // ================ æ¸²æŸ“å‡½æ•° ================
        // 1. æ¸²æŸ“æ—¥å†ä¾§è¾¹æ 
        function renderCalendar() {
            const container = document.getElementById('calendarList');
            container.innerHTML = '';
            
            // ç”Ÿæˆæœ€è¿‘5å¤©çš„æ—¥æœŸ
            for (let i = 4; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = getDateStr(date);
                
                const dateItem = document.createElement('div');
                dateItem.className = `date-item ${dateStr === currentViewingDate ? 'active' : ''}`;
                
                const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const dayName = dayNames[date.getDay()];
                const displayDate = date.getDate();
                const month = date.getMonth() + 1;
                const isToday = dateStr === TODAY_STR;
                
                dateItem.innerHTML = `
                    <div>${month}/${displayDate} å‘¨${dayName}</div>
                    <div style="font-size:0.75em; opacity:0.7;">
                        ${getTaskCountForDate(dateStr)} ä¸ªä»»åŠ¡
                        ${isToday ? '<span class="today-badge">ä»Š</span>' : ''}
                    </div>
                `;
                
                dateItem.addEventListener('click', () => switchViewingDate(dateStr));
                container.appendChild(dateItem);
            }
        }
        
        // è·å–æ—¥æœŸä»»åŠ¡æ•°é‡
        function getTaskCountForDate(dateStr) {
            const dateData = allDailyTasks[dateStr];
            if (!dateData) return 0;
            
            const dynamicCount = dateData.dynamicTasks.length;
            const fixedCount = fixedTasks.length;
            return dynamicCount + fixedCount;
        }
        
        // 2. åˆ‡æ¢æŸ¥çœ‹æ—¥æœŸ
        function switchViewingDate(dateStr) {
            currentViewingDate = dateStr;
            ensureDateData(dateStr);
            renderCalendar();
            renderAllTasksForDate(dateStr);
            
            // æ›´æ–°æ ‡é¢˜
            const title = document.getElementById('todayDateTitle');
            const date = new Date(dateStr);
            const dayDiff = Math.round((date - TODAY) / (1000*60*60*24));
            
            let dayText = '';
            if (dayDiff === 0) dayText = 'ä»Šå¤©';
            else if (dayDiff === -1) dayText = 'æ˜¨å¤©';
            else if (dayDiff === 1) dayText = 'æ˜å¤©';
            else dayText = `${date.getMonth()+1}/${date.getDate()}`;
            
            title.textContent = `ğŸ“ ${dayText}çš„åŠ¨æ€ä»»åŠ¡`;
        }
        
        // 3. æ¸²æŸ“æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰ä»»åŠ¡
        function renderAllTasksForDate(dateStr) {
            const dateData = allDailyTasks[dateStr];
            if (!dateData) return;
            
            // æ¸²æŸ“å›ºå®šä»»åŠ¡
            const fixedContainer = document.getElementById('fixedTasksContainer');
            fixedContainer.innerHTML = '';
            
            fixedTasks.forEach(fixedTask => {
                const isCompleted = dateData.fixedTaskStatus[fixedTask.id] || false;
                const taskElem = createTaskElement(
                    fixedTask.text,
                    isCompleted,
                    'fixed',
                    fixedTask.id,
                    dateStr
                );
                fixedContainer.appendChild(taskElem);
            });
            
            // æ¸²æŸ“åŠ¨æ€ä»»åŠ¡
            const dynamicContainer = document.getElementById('dynamicTasksContainer');
            dynamicContainer.innerHTML = '';
            
            dateData.dynamicTasks.forEach((task, index) => {
                const taskElem = createTaskElement(
                    task.text,
                    task.completed,
                    'dynamic',
                    index,
                    dateStr
                );
                dynamicContainer.appendChild(taskElem);
            });
        }
        
        // 4. åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(text, completed, type, id, dateStr) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = completed;
            
            checkbox.addEventListener('change', () => {
                updateTaskCompletion(type, id, dateStr, checkbox.checked);
            });
            
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'task-text';
            textInput.value = text;
            
            textInput.addEventListener('change', () => {
                updateTaskText(type, id, dateStr, textInput.value);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                    deleteTask(type, id, dateStr);
                }
            });
            
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(textInput);
            
            if (type === 'fixed') {
                const fixedIndicator = document.createElement('span');
                fixedIndicator.className = 'fixed-indicator';
                fixedIndicator.textContent = 'å›ºå®š';
                taskDiv.appendChild(fixedIndicator);
            } else {
                taskDiv.appendChild(deleteBtn);
            }
            
            return taskDiv;
        }
        
        // ================ æ•°æ®æ“ä½œå‡½æ•° ================
        function updateTaskCompletion(type, id, dateStr, completed) {
            const dateData = allDailyTasks[dateStr];
            if (type === 'fixed') {
                dateData.fixedTaskStatus[id] = completed;
            } else if (type === 'dynamic') {
                dateData.dynamicTasks[id].completed = completed;
            }
            saveAllDailyTasks();
        }
        
        function updateTaskText(type, id, dateStr, newText) {
            if (type === 'fixed') {
                const task = fixedTasks.find(t => t.id === id);
                if (task) {
                    task.text = newText;
                    saveFixedTasks();
                    renderAllTasksForDate(currentViewingDate);
                }
            } else if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks[id].text = newText;
                saveAllDailyTasks();
            }
        }
        
        function deleteTask(type, id, dateStr) {
            if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks.splice(id, 1);
                saveAllDailyTasks();
                renderAllTasksForDate(dateStr);
            }
        }
        
        // ================ äº‹ä»¶å¤„ç† ================
        // 1. æŠ˜å /å±•å¼€ä¾§è¾¹æ 
        document.getElementById('toggleSidebarBtn').addEventListener('click', function() {
            const sidebar = document.getElementById('calendarSidebar');
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                this.textContent = 'â–¶';
                this.title = 'å±•å¼€æ—¥å†';
            } else {
                sidebar.classList.remove('collapsed');
                this.textContent = 'â—€';
                this.title = 'æŠ˜å æ—¥å†';
            }
        });
        
        // 2. æ·»åŠ åŠ¨æ€ä»»åŠ¡
        document.getElementById('addDynamicTaskBtn').addEventListener('click', () => {
            const dateData = allDailyTasks[currentViewingDate];
            const taskText = prompt('è¯·è¾“å…¥æ–°ä»»åŠ¡å†…å®¹ï¼š', 'æ–°ä»»åŠ¡');
            
            if (taskText && taskText.trim()) {
                dateData.dynamicTasks.push({
                    text: taskText.trim(),
                    completed: false
                });
                saveAllDailyTasks();
                renderAllTasksForDate(currentViewingDate);
            }
        });
        
        // 3. å¤åˆ¶æ˜¨å¤©ä»»åŠ¡
        document.getElementById('copyYesterdayBtn').addEventListener('click', () => {
            const yesterday = new Date(TODAY);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getDateStr(yesterday);
            const yesterdayData = allDailyTasks[yesterdayStr];
            
            if (!yesterdayData) {
                alert('æ˜¨å¤©æ²¡æœ‰ä»»åŠ¡æ•°æ®ã€‚');
                return;
            }
            
            const todayData = allDailyTasks[currentViewingDate];
            const unfinishedDynamic = yesterdayData.dynamicTasks.filter(t => !t.completed);
            
            if (unfinishedDynamic.length === 0) {
                alert('æ˜¨å¤©æ²¡æœ‰æœªå®Œæˆçš„åŠ¨æ€ä»»åŠ¡ã€‚');
                return;
            }
            
            unfinishedDynamic.forEach(task => {
                todayData.dynamicTasks.push({
                    text: task.text,
                    completed: false
                });
            });
            
            saveAllDailyTasks();
            renderAllTasksForDate(currentViewingDate);
            alert(`å·²æ·»åŠ  ${unfinishedDynamic.length} é¡¹æ¥è‡ªæ˜¨å¤©çš„æœªå®Œæˆä»»åŠ¡ã€‚`);
        });
        
        // 4. ç®¡ç†å›ºå®šä»»åŠ¡
        document.getElementById('manageFixedTasksBtn').addEventListener('click', () => {
            const currentTasks = fixedTasks.map(ft => ft.text).join('\n');
            const input = prompt(
                'ç®¡ç†å›ºå®šä»»åŠ¡ï¼ˆæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ï¼š\nå½“å‰ä»»åŠ¡ï¼š\n' + 
                currentTasks + 
                '\n\nè¯·è¾“å…¥æ–°çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š',
                currentTasks
            );
            
            if (input !== null) {
                const newTasks = input.split('\n')
                    .map(t => t.trim())
                    .filter(t => t !== '');
                
                if (newTasks.length > 0) {
                    fixedTasks = newTasks.map((text, index) => ({
                        id: index + 1,
                        text: text,
                        completed: false
                    }));
                    
                    saveFixedTasks();
                    
                    // æ›´æ–°æ‰€æœ‰æ—¥æœŸçš„å›ºå®šä»»åŠ¡çŠ¶æ€
                    Object.keys(allDailyTasks).forEach(dateStr => {
                        const newStatus = {};
                        fixedTasks.forEach(ft => {
                            newStatus[ft.id] = allDailyTasks[dateStr].fixedTaskStatus[ft.id] || false;
                        });
                        allDailyTasks[dateStr].fixedTaskStatus = newStatus;
                    });
                    
                    saveAllDailyTasks();
                    renderAllTasksForDate(currentViewingDate);
                    alert('å›ºå®šä»»åŠ¡å·²æ›´æ–°ï¼');
                }
            }
        });
        
        // 5. åˆ‡æ¢ç´§å‡‘æ¨¡å¼
        document.getElementById('toggleCompactBtn').addEventListener('click', function() {
            document.body.classList.toggle('compact-mode');
            
            if (document.body.classList.contains('compact-mode')) {
                this.style.background = '#10b981';
                this.textContent = 'ğŸ“±';
                document.body.style.fontSize = '0.75em';
                document.body.style.padding = '5px';
            } else {
                this.style.background = '#3b82f6';
                this.textContent = 'ğŸ“±';
                document.body.style.fontSize = '0.85em';
                document.body.style.padding = '8px';
            }
        });
        
        // 6. å¯¼å‡ºæ•°æ®
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const data = {
                fixedTasks: fixedTasks,
                allDailyTasks: allDailyTasks,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä»»åŠ¡æ•°æ®_${TODAY_STR}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼');
        });
        
        // ================ åˆå§‹åŒ–åº”ç”¨ ================
        renderCalendar();
        renderAllTasksForDate(TODAY_STR);
        
        // é»˜è®¤æŠ˜å ä¾§è¾¹æ 
        setTimeout(() => {
            document.getElementById('toggleSidebarBtn').click();
        }, 300);
    </script>
</body>
</html>
