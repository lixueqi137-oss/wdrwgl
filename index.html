<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥ä»»åŠ¡ç®¡ç†å™¨ (å¢å¼ºç‰ˆ)</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            display: flex;
            min-height: 100vh;
        }
        /* æ—¥å†ä¾§è¾¹æ  */
        #calendarSidebar {
            width: 200px;
            margin-right: 25px;
            flex-shrink: 0;
        }
        #calendarSidebar h3 { color: #333; margin-top: 0; }
        .date-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .date-item:hover { background: #edf7ed; transform: translateX(2px); }
        .date-item.active {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }
        /* ä¸»ä»»åŠ¡åŒºåŸŸ */
        #mainArea {
            flex-grow: 1;
            max-width: 700px;
        }
        .task-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* ä»»åŠ¡é¡¹æ ·å¼ */
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .task-item:last-child { border-bottom: none; }
        .task-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #4CAF50; /* å¤é€‰æ¡†é¢œè‰² */
        }
        .task-text {
            flex-grow: 1;
            border: none;
            font-size: 1em;
            padding: 5px;
            background: transparent;
            color: #333;
        }
        .task-text:focus {
            outline: none;
            background: #f9f9f9;
            border-radius: 4px;
        }
        /* å·²å®Œæˆä»»åŠ¡ï¼šåªå˜æ·¡ï¼Œä¸åˆ’æ‰ */
        .task-checkbox:checked + .task-text {
            color: #95a5a6; /* æ–‡æœ¬å˜æ·¡ç°è‰² */
            /* æ²¡æœ‰ text-decoration: line-through; */
        }
        .delete-btn {
            opacity: 0;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: opacity 0.2s;
        }
        .task-item:hover .delete-btn { opacity: 1; }
        /* æŒ‰é’®æ ·å¼ */
        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-right: 10px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .action-btn:hover { background: #45a049; }
        .action-btn.secondary {
            background: #6c757d;
        }
        .action-btn.secondary:hover {
            background: #5a6268;
        }
        #controls { margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- æ—¥å†ä¾§è¾¹æ  -->
    <div id="calendarSidebar">
        <h3>ğŸ—“ï¸ ä»»åŠ¡æ—¥å†</h3>
        <div id="calendarList">
            <!-- æ—¥æœŸé¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ä¸»ä»»åŠ¡åŒºåŸŸ -->
    <div id="mainArea">
        <div id="controls">
            <button class="action-btn" id="addDynamicTaskBtn">+ æ·»åŠ ä»Šæ—¥ä»»åŠ¡</button>
            <button class="action-btn secondary" id="copyYesterdayBtn">ğŸ“‹ å¤åˆ¶æ˜¨å¤©æœªå®Œæˆ</button>
            <button class="action-btn secondary" id="manageFixedTasksBtn">âš™ï¸ ç®¡ç†å›ºå®šä»»åŠ¡</button>
        </div>

        <!-- å›ºå®šä»»åŠ¡åŒºåŸŸ -->
        <div class="task-section">
            <h3 class="section-title">
                ğŸ”„ æ¯æ—¥å›ºå®šä»»åŠ¡
                <small style="font-size:0.8em; color:#7f8c8d;">ï¼ˆæ¯å¤©è‡ªåŠ¨å‡ºç°ï¼‰</small>
            </h3>
            <div id="fixedTasksContainer"></div>
        </div>

        <!-- ä»Šæ—¥åŠ¨æ€ä»»åŠ¡åŒºåŸŸ -->
        <div class="task-section">
            <h3 class="section-title" id="todayDateTitle">ğŸ“ ä»Šæ—¥åŠ¨æ€ä»»åŠ¡</h3>
            <div id="dynamicTasksContainer"></div>
        </div>
    </div>

    <script>
        // ================ æ ¸å¿ƒå·¥å…·å‡½æ•° ================
        function getDateStr(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }

        // ================ çŠ¶æ€ä¸æ—¥æœŸç®¡ç† ================
        const TODAY = new Date();
        const TODAY_STR = getDateStr(TODAY);
        let currentViewingDate = TODAY_STR; // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„æ—¥æœŸ

        // ================ æ•°æ®æ¨¡å‹ ================
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–
        let fixedTasks = JSON.parse(localStorage.getItem('fixedTasks')) || [
            { id: 1, text: "é˜…è¯»30åˆ†é’Ÿ", completed: false },
            { id: 2, text: "è¿åŠ¨é”»ç‚¼", completed: false }
        ];
        // dailyTasks ç»“æ„ï¼š { "2023-10-27": { dynamicTasks: [...], fixedTaskStatus: {"1": true, "2": false} } }
        let allDailyTasks = JSON.parse(localStorage.getItem('allDailyTasks')) || {};

        // ================ åˆå§‹åŒ–ï¼šç¡®ä¿ä»Šå¤©çš„æ•°æ®å­˜åœ¨ ================
        function ensureDateData(dateStr) {
            if (!allDailyTasks[dateStr]) {
                allDailyTasks[dateStr] = {
                    dynamicTasks: [],
                    fixedTaskStatus: {}
                };
                // åˆå§‹åŒ–å›ºå®šä»»åŠ¡çŠ¶æ€ä¸ºæœªå®Œæˆ
                fixedTasks.forEach(ft => {
                    allDailyTasks[dateStr].fixedTaskStatus[ft.id] = false;
                });
                saveAllDailyTasks();
            }
        }
        ensureDateData(TODAY_STR);

        // ================ æ•°æ®æŒä¹…åŒ–å‡½æ•° ================
        function saveFixedTasks() {
            localStorage.setItem('fixedTasks', JSON.stringify(fixedTasks));
        }
        function saveAllDailyTasks() {
            localStorage.setItem('allDailyTasks', JSON.stringify(allDailyTasks));
        }

        // ================ æ¸²æŸ“å‡½æ•° ================
        // 1. æ¸²æŸ“æ—¥å†ä¾§è¾¹æ 
        function renderCalendar() {
            const container = document.getElementById('calendarList');
            container.innerHTML = '';
            // ç”Ÿæˆæœ€è¿‘7å¤©ï¼ˆå¯è°ƒæ•´ï¼‰çš„æ—¥æœŸ
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = getDateStr(date);
                const dateItem = document.createElement('div');
                dateItem.className = `date-item ${dateStr === currentViewingDate ? 'active' : ''}`;
                const dayNames = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
                const dayName = dayNames[date.getDay()];
                const displayDate = date.getDate();
                const isToday = dateStr === TODAY_STR;
                dateItem.innerHTML = `${isToday ? '<strong>ä»Šå¤©</strong>' : `${date.getMonth()+1}/${displayDate}`} ${dayName}`;
                dateItem.addEventListener('click', () => switchViewingDate(dateStr));
                container.appendChild(dateItem);
            }
        }

        // 2. åˆ‡æ¢æŸ¥çœ‹çš„æ—¥æœŸ
        function switchViewingDate(dateStr) {
            currentViewingDate = dateStr;
            ensureDateData(dateStr); // åˆ‡æ¢åˆ°æŸå¤©æ—¶ç¡®ä¿æ•°æ®å­˜åœ¨
            renderCalendar();
            renderAllTasksForDate(dateStr);
            // æ›´æ–°ä¸»åŒºåŸŸæ ‡é¢˜
            const title = document.getElementById('todayDateTitle');
            const dayDiff = Math.round((new Date(dateStr) - TODAY) / (1000*60*60*24));
            let dayText = '';
            if (dayDiff === 0) dayText = 'ä»Šå¤©';
            else if (dayDiff === -1) dayText = 'æ˜¨å¤©';
            else if (dayDiff === 1) dayText = 'æ˜å¤©';
            else dayText = dateStr;
            title.textContent = `ğŸ“ ${dayText}çš„åŠ¨æ€ä»»åŠ¡`;
        }

        // 3. ä¸ºæŒ‡å®šæ—¥æœŸæ¸²æŸ“æ‰€æœ‰ä»»åŠ¡ï¼ˆå›ºå®š+åŠ¨æ€ï¼‰
        function renderAllTasksForDate(dateStr) {
            const dateData = allDailyTasks[dateStr];
            if (!dateData) return;

            // æ¸²æŸ“å›ºå®šä»»åŠ¡
            const fixedContainer = document.getElementById('fixedTasksContainer');
            fixedContainer.innerHTML = '';
            fixedTasks.forEach(fixedTask => {
                const isCompleted = dateData.fixedTaskStatus[fixedTask.id] || false;
                const taskElem = createTaskElement(
                    fixedTask.text,
                    isCompleted,
                    'fixed',
                    fixedTask.id,
                    dateStr
                );
                fixedContainer.appendChild(taskElem);
            });

            // æ¸²æŸ“åŠ¨æ€ä»»åŠ¡
            const dynamicContainer = document.getElementById('dynamicTasksContainer');
            dynamicContainer.innerHTML = '';
            dateData.dynamicTasks.forEach((task, index) => {
                const taskElem = createTaskElement(
                    task.text,
                    task.completed,
                    'dynamic',
                    index,
                    dateStr
                );
                dynamicContainer.appendChild(taskElem);
            });
        }

        // 4. åˆ›å»ºå•ä¸ªä»»åŠ¡å…ƒç´ çš„é€šç”¨å‡½æ•° (ä¿®å¤äº†äº‹ä»¶ç»‘å®šçš„æ ¸å¿ƒ)
        function createTaskElement(text, completed, type, id, dateStr) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = completed;

            // å…³é”®ä¿®å¤ï¼šä½¿ç”¨é—­åŒ…æ•è·å½“å‰å‚æ•°ï¼Œç¡®ä¿äº‹ä»¶è§¦å‘æ—¶èƒ½æ­£ç¡®æ›´æ–°æ•°æ®
            checkbox.addEventListener('change', () => {
                updateTaskCompletion(type, id, dateStr, checkbox.checked);
            });

            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'task-text';
            textInput.value = text;
            textInput.addEventListener('change', () => {
                updateTaskText(type, id, dateStr, textInput.value);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.addEventListener('click', () => {
                deleteTask(type, id, dateStr);
            });

            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(textInput);
            if (type === 'dynamic') {
                taskDiv.appendChild(deleteBtn); // å›ºå®šä»»åŠ¡ä¸èƒ½å•ç‹¬åˆ é™¤
            }

            return taskDiv;
        }

        // ================ æ•°æ®æ›´æ–°å‡½æ•° ================
        // 1. æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function updateTaskCompletion(type, id, dateStr, completed) {
            const dateData = allDailyTasks[dateStr];
            if (type === 'fixed') {
                dateData.fixedTaskStatus[id] = completed;
            } else if (type === 'dynamic') {
                dateData.dynamicTasks[id].completed = completed;
            }
            saveAllDailyTasks();
            // è§†è§‰æ›´æ–°ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡ç»˜å…¨éƒ¨
        }

        // 2. æ›´æ–°ä»»åŠ¡æ–‡æœ¬
        function updateTaskText(type, id, dateStr, newText) {
            if (type === 'fixed') {
                fixedTasks.find(t => t.id === id).text = newText;
                saveFixedTasks();
                // å›ºå®šä»»åŠ¡æ–‡æœ¬å˜æ›´ï¼Œéœ€è¦é‡ç»˜æ‰€æœ‰æ—¥æœŸçš„è¯¥ä»»åŠ¡
                renderAllTasksForDate(currentViewingDate);
            } else if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks[id].text = newText;
                saveAllDailyTasks();
            }
        }

        // 3. åˆ é™¤ä»»åŠ¡ï¼ˆä»…åŠ¨æ€ä»»åŠ¡ï¼‰
        function deleteTask(type, id, dateStr) {
            if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks.splice(id, 1);
                saveAllDailyTasks();
                renderAllTasksForDate(dateStr); // é‡æ–°æ¸²æŸ“
            }
        }

        // ================ æŒ‰é’®äº‹ä»¶ç»‘å®š ================
        document.getElementById('addDynamicTaskBtn').addEventListener('click', () => {
            const dateData = allDailyTasks[currentViewingDate];
            dateData.dynamicTasks.push({
                text: "æ–°ä»»åŠ¡",
                completed: false
            });
            saveAllDailyTasks();
            renderAllTasksForDate(currentViewingDate);
        });

        document.getElementById('copyYesterdayBtn').addEventListener('click', () => {
            const yesterday = new Date(TODAY);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getDateStr(yesterday);
            const yesterdayData = allDailyTasks[yesterdayStr];

            if (!yesterdayData) {
                alert('æ˜¨å¤©æ²¡æœ‰æ•°æ®å¯å¤åˆ¶ã€‚');
                return;
            }

            const todayData = allDailyTasks[currentViewingDate];
            const unfinishedDynamic = yesterdayData.dynamicTasks.filter(t => !t.completed);
            unfinishedDynamic.forEach(task => {
                todayData.dynamicTasks.push({
                    text: task.text + " (æ¥è‡ªæ˜¨å¤©)",
                    completed: false
                });
            });

            // å¤åˆ¶å›ºå®šä»»åŠ¡çš„æœªå®ŒæˆçŠ¶æ€ï¼ˆå¯é€‰ï¼‰
            Object.keys(yesterdayData.fixedTaskStatus).forEach(ftId => {
                if (!yesterdayData.fixedTaskStatus[ftId]) {
                    todayData.fixedTaskStatus[ftId] = false; // ç¡®ä¿æ˜¨å¤©æœªå®Œæˆçš„å›ºå®šä»»åŠ¡ä»Šå¤©ä¹Ÿæ˜¯æœªå®Œæˆ
                }
            });

            saveAllDailyTasks();
            renderAllTasksForDate(currentViewingDate);
            alert(`å·²å¤åˆ¶ ${unfinishedDynamic.length} é¡¹æœªå®Œæˆçš„åŠ¨æ€ä»»åŠ¡ã€‚`);
        });

        // ç®¡ç†å›ºå®šä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼šè·³è½¬åˆ°æ–°é¡µé¢æˆ–å¼¹çª—ï¼‰
        document.getElementById('manageFixedTasksBtn').addEventListener('click', () => {
            const input = prompt(
                'ç®¡ç†å›ºå®šä»»åŠ¡ï¼ˆæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ï¼š\nå½“å‰ä»»åŠ¡ï¼š\n' +
                fixedTasks.map(ft => ft.text).join('\n') +
                '\n\nè¯·è¾“å…¥æ–°çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼š',
                fixedTasks.map(ft => ft.text).join('\n')
            );
            if (input !== null) {
                const newTasks = input.split('\n').filter(t => t.trim() !== '');
                // ç”Ÿæˆæ–°çš„å›ºå®šä»»åŠ¡ï¼ˆä¿ç•™åŸæœ‰IDé¡ºåºï¼‰
                fixedTasks = newTasks.map((text, index) => ({
                    id: index + 1,
                    text: text.trim(),
                    completed: false
                }));
                saveFixedTasks();
                // éœ€è¦æ›´æ–°æ‰€æœ‰æ—¥æœŸçš„ fixedTaskStatus
                Object.keys(allDailyTasks).forEach(dateStr => {
                    const newStatus = {};
                    fixedTasks.forEach(ft => {
                        // å¦‚æœè¯¥æ—¥æœŸå·²æœ‰æ­¤ä»»åŠ¡çš„çŠ¶æ€ï¼Œåˆ™ä¿ç•™ï¼›å¦åˆ™åˆå§‹åŒ–ä¸ºfalse
                        newStatus[ft.id] = allDailyTasks[dateStr].fixedTaskStatus[ft.id] || false;
                    });
                    allDailyTasks[dateStr].fixedTaskStatus = newStatus;
                });
                saveAllDailyTasks();
                renderAllTasksForDate(currentViewingDate);
                alert('å›ºå®šä»»åŠ¡å·²æ›´æ–°ï¼');
            }
        });

        // ================ åˆå§‹åŒ–æ¸²æŸ“ ================
        renderCalendar();
        renderAllTasksForDate(TODAY_STR);
    </script>
</body>
</html>
