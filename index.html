<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚¬æµ®ä»»åŠ¡ç®¡ç†å™¨</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 10px;
            background: #f8f9fa;
            color: #333;
            font-size: 0.85em;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            max-width: 900px;
            margin: 0 auto;
        }
        #calendarSidebar {
            width: 160px;
            background: #f1f3f4;
            padding: 12px;
            transition: all 0.3s ease;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
            position: relative;
        }
        #calendarSidebar.collapsed {
            width: 0;
            padding: 12px 0;
            border-right: none;
            overflow: hidden;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #calendarSidebar h3 {
            margin: 0;
            font-size: 1em;
            color: #444;
            font-weight: 600;
        }
        .toggle-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .toggle-btn:hover { background: #45a049; }
        #calendarList {
            max-height: 400px;
            overflow-y: auto;
        }
        .date-item {
            padding: 6px 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            border-left: 3px solid #4CAF50;
            font-size: 0.75em;
            transition: all 0.2s;
        }
        .date-item:hover { background: #edf7ed; }
        .date-item.active {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }
        #mainArea {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 95vh;
        }
        .task-section {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #eaeaea;
        }
        .section-title {
            font-size: 0.95em;
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #eee;
        }
        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .action-btn:hover { background: #45a049; }
        .action-btn.secondary {
            background: #6c757d;
        }
        .action-btn.secondary:hover {
            background: #5a6268;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
            min-height: 32px;
        }
        .task-item:last-child { border-bottom: none; }
        .task-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #4CAF50;
            flex-shrink: 0;
        }
        .task-text-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0;
        }
        .priority-dot {
            color: #ff4757;
            margin-right: 6px;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        .task-text {
            border: none;
            font-size: 0.9em;
            padding: 2px 4px;
            background: transparent;
            color: #333;
            flex-grow: 1;
            min-width: 0;
        }
        .task-text:focus {
            outline: none;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .task-checkbox:checked + .task-text-container .task-text {
            color: #95a5a6;
        }
        .priority-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            margin-left: 8px;
            color: #ccc;
            flex-shrink: 0;
            padding: 2px;
        }
        .priority-btn.active {
            color: #ffa502;
        }
        .delete-btn {
            opacity: 0;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 0.75em;
            margin-left: 8px;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        .task-item:hover .delete-btn { opacity: 1; }
        .priority-section {
            border-left: 3px solid #ff4757;
            background-color: #fff9f9;
        }
        .empty-placeholder {
            color: #999;
            text-align: center;
            font-style: italic;
            padding: 10px 0;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="calendarSidebar">
            <div class="calendar-header">
                <h3>ğŸ—“ï¸ æ—¥å†</h3>
                <button class="toggle-btn" id="sidebarToggle">â—€</button>
            </div>
            <div id="calendarList"></div>
        </div>

        <div id="mainArea">
            <div id="controls">
                <button class="action-btn" id="addDynamicTaskBtn">+ ä»Šæ—¥ä»»åŠ¡</button>
                <button class="action-btn secondary" id="copyYesterdayBtn">ğŸ“‹ å¤åˆ¶æ˜¨å¤©</button>
                <button class="action-btn secondary" id="manageFixedTasksBtn">âš™ï¸ ç®¡ç†å›ºå®š</button>
            </div>

            <!-- é¡ºåºå·²è°ƒæ•´ï¼šå›ºå®šä»»åŠ¡ -> ä¼˜å…ˆå¾…åŠ -> åŠ¨æ€ä»»åŠ¡ -->
            <div class="task-section">
                <h3 class="section-title">
                    ğŸ”„ æ¯æ—¥å›ºå®šä»»åŠ¡
                    <small style="color:#7f8c8d;">ï¼ˆæ¯å¤©è‡ªåŠ¨å‡ºç°ï¼‰</small>
                </h3>
                <div id="fixedTasksContainer"></div>
            </div>

            <div class="task-section priority-section">
                <h3 class="section-title">
                    <span style="color: #ff4757;">â—</span> ä¼˜å…ˆå¾…åŠ
                    <small style="color:#7f8c8d;">ï¼ˆé«˜é‡è¦æ€§ï¼‰</small>
                </h3>
                <div id="priorityTasksContainer"></div>
            </div>

            <div class="task-section">
                <h3 class="section-title" id="todayDateTitle">ğŸ“ ä»Šæ—¥åŠ¨æ€ä»»åŠ¡</h3>
                <div id="dynamicTasksContainer"></div>
            </div>
        </div>
    </div>

    <script>
        function getDateStr(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }
        const TODAY = new Date();
        const TODAY_STR = getDateStr(TODAY);
        let currentViewingDate = TODAY_STR;
        let fixedTasks = JSON.parse(localStorage.getItem('fixedTasks')) || [
            { id: 1, text: "é˜…è¯»30åˆ†é’Ÿ", completed: false, priority: false },
            { id: 2, text: "è¿åŠ¨é”»ç‚¼", completed: false, priority: true }
        ];
        let allDailyTasks = JSON.parse(localStorage.getItem('allDailyTasks')) || {};
        function saveFixedTasks() {
            localStorage.setItem('fixedTasks', JSON.stringify(fixedTasks));
        }
        function saveAllDailyTasks() {
            localStorage.setItem('allDailyTasks', JSON.stringify(allDailyTasks));
        }
        function ensureDateData(dateStr) {
            if (!allDailyTasks[dateStr]) {
                allDailyTasks[dateStr] = {
                    dynamicTasks: [],
                    fixedTaskStatus: {}
                };
                fixedTasks.forEach(ft => {
                    allDailyTasks[dateStr].fixedTaskStatus[ft.id] = false;
                });
                saveAllDailyTasks();
            }
        }
        ensureDateData(TODAY_STR);
        function renderCalendar() {
            const container = document.getElementById('calendarList');
            container.innerHTML = '';
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = getDateStr(date);
                const dateItem = document.createElement('div');
                dateItem.className = `date-item ${dateStr === currentViewingDate ? 'active' : ''}`;
                const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                const dayName = dayNames[date.getDay()];
                const displayDate = date.getDate();
                const month = date.getMonth() + 1;
                dateItem.innerHTML = `${month}/${displayDate} å‘¨${dayName}`;
                dateItem.addEventListener('click', () => switchViewingDate(dateStr));
                container.appendChild(dateItem);
            }
        }
        function switchViewingDate(dateStr) {
            currentViewingDate = dateStr;
            ensureDateData(dateStr);
            renderCalendar();
            renderAllTasks();
        }
        function renderAllTasks() {
            const dateData = allDailyTasks[currentViewingDate];
            if (!dateData) return;
            renderFixedTasks(dateData);
            renderPriorityTasks(dateData);
            renderDynamicTasks(dateData);
            updateDateTitle();
        }
        function renderFixedTasks(dateData) {
            const container = document.getElementById('fixedTasksContainer');
            container.innerHTML = '';
            fixedTasks.forEach(ft => {
                if (!ft.priority) {
                    const task = {
                        type: 'fixed',
                        id: ft.id,
                        text: ft.text,
                        completed: dateData.fixedTaskStatus[ft.id] || false,
                        priority: ft.priority
                    };
                    container.appendChild(createTaskElement(task, currentViewingDate));
                }
            });
            if (container.innerHTML === '') {
                container.innerHTML = '<p class="empty-placeholder">æ‰€æœ‰å›ºå®šä»»åŠ¡å‡å·²è®¾ä¸ºä¼˜å…ˆ</p>';
            }
        }
        function renderPriorityTasks(dateData) {
            const container = document.getElementById('priorityTasksContainer');
            container.innerHTML = '';
            let priorityTasks = [];
            fixedTasks.forEach(ft => {
                if (ft.priority && dateData.fixedTaskStatus[ft.id] !== undefined) {
                    priorityTasks.push({
                        type: 'fixed',
                        id: ft.id,
                        text: ft.text,
                        completed: dateData.fixedTaskStatus[ft.id],
                        priority: true
                    });
                }
            });
            dateData.dynamicTasks.forEach((task, index) => {
                if (task.priority) {
                    priorityTasks.push({
                        type: 'dynamic',
                        id: index,
                        text: task.text,
                        completed: task.completed,
                        priority: true
                    });
                }
            });
            if (priorityTasks.length === 0) {
                container.innerHTML = '<p class="empty-placeholder">æš‚æ— ä¼˜å…ˆä»»åŠ¡</p>';
                return;
            }
            priorityTasks.forEach(task => {
                container.appendChild(createTaskElement(task, currentViewingDate));
            });
        }
        function renderDynamicTasks(dateData) {
            const container = document.getElementById('dynamicTasksContainer');
            container.innerHTML = '';
            dateData.dynamicTasks.forEach((task, index) => {
                if (!task.priority) {
                    const taskObj = {
                        type: 'dynamic',
                        id: index,
                        text: task.text,
                        completed: task.completed,
                        priority: task.priority
                    };
                    container.appendChild(createTaskElement(taskObj, currentViewingDate));
                }
            });
            if (container.innerHTML === '' && dateData.dynamicTasks.length > 0) {
                container.innerHTML = '<p class="empty-placeholder">æ‰€æœ‰åŠ¨æ€ä»»åŠ¡å‡å·²è®¾ä¸ºä¼˜å…ˆ</p>';
            } else if (dateData.dynamicTasks.length === 0) {
                container.innerHTML = '<p class="empty-placeholder">æš‚æ— åŠ¨æ€ä»»åŠ¡</p>';
            }
        }
        function updateDateTitle() {
            const title = document.getElementById('todayDateTitle');
            const currentDate = new Date(currentViewingDate);
            const today = new Date(TODAY_STR);
            const diff = Math.round((currentDate - today) / (1000 * 60 * 60 * 24));
            let prefix = "ğŸ“ ";
            if (diff === 0) prefix = "ğŸ“ ä»Šå¤©";
            else if (diff === -1) prefix = "ğŸ“ æ˜¨å¤©";
            else if (diff === 1) prefix = "ğŸ“ æ˜å¤©";
            else prefix = `ğŸ“ ${currentViewingDate.substring(5).replace('-', '/')}`;
            title.textContent = prefix + " åŠ¨æ€ä»»åŠ¡";
        }
        function createTaskElement(task, dateStr) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = task.completed;
            checkbox.addEventListener('change', () => {
                updateTaskCompletion(task.type, task.id, dateStr, checkbox.checked);
            });
            const textContainer = document.createElement('div');
            textContainer.className = 'task-text-container';
            if (task.priority) {
                const redDot = document.createElement('span');
                redDot.className = 'priority-dot';
                redDot.textContent = 'â—';
                textContainer.appendChild(redDot);
            }
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'task-text';
            textInput.value = task.text;
            if (task.priority) {
                textInput.style.fontWeight = '500';
            }
            textInput.addEventListener('change', () => {
                updateTaskText(task.type, task.id, dateStr, textInput.value);
            });
            textContainer.appendChild(textInput);
            const priorityBtn = document.createElement('button');
            priorityBtn.className = `priority-btn ${task.priority ? 'active' : ''}`;
            priorityBtn.innerHTML = task.priority ? 'â˜…' : 'â˜†';
            priorityBtn.title = 'åˆ‡æ¢ä¼˜å…ˆçº§';
            priorityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleTaskPriority(task.type, task.id, dateStr);
            });
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.addEventListener('click', () => {
                deleteTask(task.type, task.id, dateStr);
            });
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(textContainer);
            taskDiv.appendChild(priorityBtn);
            if (task.type === 'dynamic') {
                taskDiv.appendChild(deleteBtn);
            }
            return taskDiv;
        }
        function updateTaskCompletion(type, id, dateStr, completed) {
            const dateData = allDailyTasks[dateStr];
            if (type === 'fixed') {
                dateData.fixedTaskStatus[id] = completed;
            } else if (type === 'dynamic') {
                dateData.dynamicTasks[id].completed = completed;
            }
            saveAllDailyTasks();
            renderAllTasks();
        }
        function updateTaskText(type, id, dateStr, newText) {
            if (type === 'fixed') {
                const task = fixedTasks.find(t => t.id === id);
                if (task) {
                    task.text = newText;
                    saveFixedTasks();
                }
            } else if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks[id].text = newText;
                saveAllDailyTasks();
            }
            renderAllTasks();
        }
        function toggleTaskPriority(type, id, dateStr) {
            if (type === 'fixed') {
                const task = fixedTasks.find(t => t.id === id);
                if (task) {
                    task.priority = !task.priority;
                    saveFixedTasks();
                }
            } else if (type === 'dynamic') {
                const task = allDailyTasks[dateStr].dynamicTasks[id];
                if (task) {
                    task.priority = !task.priority;
                    saveAllDailyTasks();
                }
            }
            renderAllTasks();
        }
        function deleteTask(type, id, dateStr) {
            if (type === 'dynamic') {
                allDailyTasks[dateStr].dynamicTasks.splice(id, 1);
                saveAllDailyTasks();
                renderAllTasks();
            }
        }
        document.getElementById('addDynamicTaskBtn').addEventListener('click', () => {
            const dateData = allDailyTasks[currentViewingDate];
            dateData.dynamicTasks.push({
                text: "æ–°ä»»åŠ¡",
                completed: false,
                priority: false
            });
            saveAllDailyTasks();
            renderAllTasks();
        });
        document.getElementById('copyYesterdayBtn').addEventListener('click', () => {
            const currentDate = new Date(currentViewingDate);
            const yesterday = new Date(currentDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getDateStr(yesterday);
            const yesterdayData = allDailyTasks[yesterdayStr];
            if (!yesterdayData || yesterdayData.dynamicTasks.length === 0) {
                alert('æ˜¨å¤©æ²¡æœ‰åŠ¨æ€ä»»åŠ¡å¯å¤åˆ¶ã€‚');
                return;
            }
            const todayData = allDailyTasks[currentViewingDate];
            const unfinishedDynamic = yesterdayData.dynamicTasks.filter(t => !t.completed);
            unfinishedDynamic.forEach(task => {
                todayData.dynamicTasks.push({
                    text: task.text,
                    completed: false,
                    priority: task.priority
                });
            });
            saveAllDailyTasks();
            renderAllTasks();
            alert(`å·²å¤åˆ¶ ${unfinishedDynamic.length} é¡¹æœªå®Œæˆçš„ä»»åŠ¡ã€‚`);
        });
        document.getElementById('manageFixedTasksBtn').addEventListener('click', () => {
            const input = prompt(
                'ç®¡ç†å›ºå®šä»»åŠ¡ï¼ˆæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ï¼š\nå½“å‰ä»»åŠ¡ï¼š\n' +
                fixedTasks.map(ft => ft.text).join('\n') +
                '\n\nè¯·è¾“å…¥æ–°çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼š',
                fixedTasks.map(ft => ft.text).join('\n')
            );
            if (input !== null) {
                const newTasks = input.split('\n').filter(t => t.trim() !== '');
                fixedTasks = newTasks.map((text, index) => ({
                    id: index + 1,
                    text: text.trim(),
                    completed: false,
                    priority: false
                }));
                saveFixedTasks();
                Object.keys(allDailyTasks).forEach(dateStr => {
                    const newStatus = {};
                    fixedTasks.forEach(ft => {
                        newStatus[ft.id] = allDailyTasks[dateStr].fixedTaskStatus[ft.id] || false;
                    });
                    allDailyTasks[dateStr].fixedTaskStatus = newStatus;
                });
                saveAllDailyTasks();
                renderAllTasks();
                alert('å›ºå®šä»»åŠ¡å·²æ›´æ–°ï¼');
            }
        });
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('calendarSidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            sidebar.classList.toggle('collapsed');
            toggleBtn.innerHTML = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
        });
        renderCalendar();
        renderAllTasks();
    </script>
</body>
</html>
